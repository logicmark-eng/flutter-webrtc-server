# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a WebRTC signaling server written in Go that provides:
- WebSocket-based signaling for WebRTC peer connections
- Built-in TURN server for NAT traversal
- REST API for TURN server credentials
- Static file serving for a Flutter web demo client

The server enables real-time peer-to-peer communication between Flutter apps (mobile/web) and HTML5 clients.

## Common Commands

### Running the Server

```bash
# Run from source (development)
go run cmd/server/main.go

# Build for current platform
go build -o bin/server cmd/server/main.go
```

### Building

```bash
# Build all platforms (Linux, macOS, Windows)
make all

# Build specific platform
make linux    # Linux amd64 and 386
make darwin   # macOS amd64
make windows  # Windows amd64 and 386

# Create release package
make release  # Builds all and creates zip

# Clean build artifacts
make clean
```

### SSL Certificate Setup

Before running the server, you need SSL certificates:

```bash
# Install mkcert (macOS)
brew install mkcert

# Generate self-signed certificates
mkcert -key-file configs/certs/key.pem -cert-file configs/certs/cert.pem localhost 127.0.0.1 ::1 0.0.0.0
```

## Architecture

### Main Components

1. **WebSocket Server** (`pkg/websocket/`)
   - HTTP/HTTPS server with WebSocket upgrade capability
   - Serves static files from `web/` directory
   - Handles two endpoints: `/ws` (WebSocket) and `/api/turn` (TURN credentials)

2. **Signaler** (`pkg/signaler/`)
   - Core signaling logic that manages peer connections
   - Maintains maps of active peers and sessions
   - Routes WebRTC signaling messages (offer/answer/candidate) between peers
   - Implements REST API for TURN credentials using HMAC-SHA1

3. **TURN Server** (`pkg/turn/`)
   - Embedded TURN server using Pion TURN library
   - Provides NAT traversal for WebRTC connections
   - Uses time-limited credentials generated by the signaler
   - Listens on UDP port (default: 19302)

### Data Flow

1. Client connects via WebSocket to `/ws`
2. Client sends "new" message with peer info (ID, name, user_agent)
3. Signaler adds peer to registry and broadcasts updated peer list
4. Clients exchange WebRTC signaling messages (offer/answer/candidate) via signaler
5. Signaler routes messages between peers based on "to" field
6. TURN credentials obtained via `/api/turn?service=turn&username=xxx`

### WebSocket Message Types

- `new`: Register new peer
- `offer`: WebRTC offer with SDP
- `answer`: WebRTC answer with SDP
- `candidate`: ICE candidate
- `bye`: End session
- `leave`: Peer leaving
- `keepalive`: Keep connection alive
- `peers`: Broadcast of active peer list (server → client)
- `error`: Error response (server → client)

### Configuration

Edit `configs/config.ini`:

**[general]**
- `domain`: Server domain name
- `cert`: Path to SSL certificate
- `key`: Path to SSL key
- `bind`: Bind address (default: 0.0.0.0)
- `port`: HTTPS port (default: 8086)
- `html_root`: Static file directory (default: web)

**[turn]**
- `public_ip`: Public IP for TURN server (REQUIRED for production)
- `port`: TURN server port (default: 19302)
- `realm`: TURN realm (default: flutter-webrtc)

### TURN Credential Security

The server implements [draft-uberti-behave-turn-rest-00](https://tools.ietf.org/html/draft-uberti-behave-turn-rest-00):
- Credentials are time-limited (TTL: 86400 seconds)
- Password generated using HMAC-SHA1 with shared key
- Shared key: `flutter-webrtc-turn-server-shared-key` (hardcoded in `pkg/signaler/signaler.go:22`)
- Credentials stored in expiring map and validated by TURN auth handler

### Dependencies

- `github.com/gorilla/websocket`: WebSocket implementation
- `github.com/pion/turn/v2`: TURN server
- `github.com/rs/zerolog`: Structured logging
- `gopkg.in/ini.v1`: INI configuration parsing
- `github.com/chuckpreslar/emission`: Event emitter for WebSocket events

### Entry Point

`cmd/server/main.go` orchestrates initialization:
1. Loads config from `configs/config.ini`
2. Creates TURN server instance
3. Creates signaler and links TURN auth handler
4. Creates WebSocket server with signaler handlers
5. Starts HTTPS server (blocking)

### Web Client

The `web/` directory contains a compiled Flutter web application (demo client). The server serves this as static content at the root path `/`.
